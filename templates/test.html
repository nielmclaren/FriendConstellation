{% extends "base.html" %}

{% block content %}

	<div id="fb-root"></div>
	
	<div id="nodePopover" class="popover fade top in" style="display:none;position:absolute;">
		<div class="arrow"></div>
		<div class="popover-content"></div>
	</div>

	<div id="constellation"></div>
	<script type="text/javascript">

		var visualizationMode = 'overview'; // 'overview' or 'explore'
		var prevSelectedNodeId;
		var ignoreHashChange = false;

		var config = {
			id: 'constellation',
			graphLoaderClass: SimpleGraphLoader,
			graphLoader: {
				url: '/chart/{{chart.id}}/data'
			},
			graphParserClass: CustomGraphParser,
			graphViewClass: DirectGraphView,
			layoutClass: CustomLayout,
			layout: {
				baseEdgeLength: 300
			}
		};
		var styles = [
			['node', {
				rendererClass: CustomNodeRenderer
			}],
			['edge', {
				rendererClass: CustomEdgeRenderer
			}]
		];

		var constellation = new Constellation(config, styles);
		$(constellation)
			.bind('log', function(event, severity, message) {
				var args = Array.prototype.slice.call(arguments, 2);
				switch (severity) {
					case 'debug':
						//window.console.debug.apply(window.console, args);
						break;
					case 'warn':
						window.console.warn.apply(window.console, args);
						break;
					case 'error':
						window.console.error.apply(window.console, args);
						break;
				}
			})
			.bind('nodeclick', function(event, nodeId) {
				var node = constellation.getNode(nodeId);

				if (constellation.getSelectedNodeId() == nodeId) {
					if ($('#nodePopover').css('display') == 'block') {
						$('#nodePopover').hide();
					}
					else {
						$('#nodePopover').show();
					}
				}
				else {
					selectNode(nodeId);
				}
			})
			.bind('click', function(event) {
				setVisualizationMode('overview');
				selectNode(null);
			})
			.bind('viewportchange', function(evt) {
				var node = constellation.getNode(constellation.getSelectedNodeId());
				if (node) {
					positionNodePopover(node);
				}
			})
			.bind('viewchanged', function(event) {
				var fragment = String(location.hash);
				if (fragment && fragment.length > 0) {
					if (fragment.charAt(0) == '#') {
						fragment = fragment.substring(1);
					}
					// If there's a URL fragment, jump to that node.
					selectNode(fragment);
				}
			});


		constellation.init();


		// If the URL fragment changes, jump to that node.
		$(window).bind('hashchange', function(event) {
			if (!ignoreHashChange) {
				var fragment = String(location.hash);
				if (fragment && fragment.length > 0) {
					if (fragment.charAt(0) == '#') {
						fragment = fragment.substring(1);
					}
					selectNode(fragment);
				}
			}
		});


		function selectNode(nodeId) {
			if (constellation.getSelectedNodeId() == nodeId) return;

			prevSelectedNodeId = constellation.getSelectedNodeId();
			constellation.setSelectedNodeId(nodeId);

			console.log("selectNode", prevSelectedNodeId + " -> " + nodeId);

			ignoreHashChange = true;
			window.location.hash = nodeId == null ? '' : nodeId;
			ignoreHashChange = false;

			var prevNode = constellation.getNode(prevSelectedNodeId);
			if (prevNode) {
				prevNode.setState('default');
				$.each(prevNode.edges, function(i, e) {
					e.setState('default');
					e.getOtherNode(prevSelectedNodeId).setState('default');
				});
			}

			var node = constellation.getNode(nodeId);
			if (node) {
				node.setState('selected');
				if (getVisualizationMode() == 'overview') {
					$.each(node.edges, function(i, e) {
						e.setState('emphasized');
						constellation.arrangeEdgeFront(e);

						var other = e.getOtherNode(nodeId);
						other.setState('emphasized');
						constellation.arrangeNodeFront(other);
					});
				}

				$('#nodePopover .popover-content').html(
					'<div style="float:left;height:50px;width:50px"><img src="' + node.data.pic_square + '" width="50" height="50" /></div>'
					+ '<div style="margin-left: 60px;min-height: 50px;"><p style="font-weight:bold"><a href="' + node.data.link + '" target="_blank" style="color:#333">' + node.data.name + '</a></p><p style="margin-left:0.4em"><a href="javascript:exploreNode(\'' + node.id + '\');">Explore &raquo;</a></div>');
				$('#nodePopover').show();

				positionNodePopover(node);
			}
			else {
				$('#nodePopover').hide();
			}

			$.each(constellation.getNodes(), function(i, n) { n.draw(); });
			$.each(constellation.getEdges(), function(i, e) { e.draw(); });
		}

		function positionNodePopover(node) {
			var offset = $(node.renderer.group).offset();
			offset.top -= $('#nodePopover').height() + 17;
			offset.left -= $('#nodePopover').width() / 2 - 3;
			$('#nodePopover').offset(offset);
		}

		function getVisualizationMode() {
			return visualizationMode;
		}
		function setVisualizationMode(mode) {
			if (visualizationMode == mode) return;
			switch (mode) {
				case 'overview':
					constellation.setGraphView(new DirectGraphView(constellation.config.graphView));
					constellation.setLayout(new CustomLayout(constellation.config.layout));
					break;

				case 'explore':
					constellation.setGraphView(new TreeGraphView({depth: 2}));
					constellation.setLayout(new RoamerLayout(constellation.config.layout));
					break;
			}
			visualizationMode = mode;
		}

		function exploreNode(nodeId) {
			setVisualizationMode('explore');
			selectNode(nodeId);
		}

	</script>

{% endblock %}
